<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Visualize trust flow in your relationships with ProActive True Valence Mapper - a professional coaching tool for understanding bidirectional trust dynamics">
    <title>ProActive True Valence Mapper - Relationship Trust Visualization</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #00A8CC 0%, #2E4A8B 100%); /* ProActive cyan to navy blue */
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
        }

        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.15);
            max-width: 1200px;
            width: 100%;
            padding: 30px;
            position: relative;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            max-width: 300px;
            height: auto;
            margin-bottom: 20px;
        }

        h1 {
            text-align: center;
            color: #2E4A8B; /* ProActive navy blue */
            margin-bottom: 10px;
            font-size: 2.2em;
            font-weight: 600;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 0;
            font-size: 1.1em;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        input[type="text"] {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #00A8CC; /* ProActive cyan */
        }

        button {
            padding: 10px 20px;
            background: #2E4A8B; /* ProActive navy blue */
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #1e3460; /* Darker navy on hover */
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 3px solid #00A8CC;
            outline-offset: 2px;
        }

        /* High contrast focus for better visibility */
        button:focus-visible,
        input:focus-visible {
            outline: 3px solid #00A8CC;
            outline-offset: 2px;
            box-shadow: 0 0 0 4px rgba(0, 168, 204, 0.2);
        }

        /* Screen reader only class */
        .sr-only {
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
        }

        /* Skip links for keyboard navigation */
        .skip-links {
            position: absolute;
            top: -100px;
            left: 0;
            z-index: 10000;
        }

        .skip-link {
            position: absolute;
            left: -10000px;
            width: 1px;
            height: 1px;
            overflow: hidden;
            background: #2E4A8B;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 0 0 8px 0;
            font-weight: bold;
        }

        .skip-link:focus {
            position: fixed;
            top: 10px;
            left: 10px;
            width: auto;
            height: auto;
            overflow: visible;
            z-index: 10001;
            outline: 3px solid #00A8CC;
        }

        /* Focus visible for SVG elements */
        .arrow-path:focus,
        .node-circle:focus {
            outline: 3px solid #00A8CC;
            outline-offset: 3px;
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            button {
                border: 2px solid currentColor;
            }

            input[type="text"] {
                border: 2px solid #000;
            }

            .arrow-path {
                stroke-width: 3.5;
            }
        }

        .visualization-container {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            min-height: 500px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        svg {
            width: 100%;
            height: 500px;
        }

        .node-circle {
            fill: #fff;
            stroke: #667eea;
            stroke-width: 2;
            cursor: pointer;
            transition: fill 0.3s;
        }

        .node-circle:hover {
            fill: #f0f4ff;
        }

        .center-node {
            fill: #667eea;
            stroke: #5563d1;
            stroke-width: 3;
        }

        .node-text {
            font-size: 12px;
            text-anchor: middle;
            pointer-events: none;
            fill: #333;
        }

        .center-text {
            fill: white;
            font-weight: bold;
            font-size: 14px;
        }

        .arrow-path {
            fill: none;
            stroke-width: 2.5;
            cursor: pointer;
            transition: stroke-width 0.3s;
            opacity: 0.9;
        }

        .arrow-path:hover {
            stroke-width: 3.5;
            opacity: 1;
        }

        .arrow-marker {
            transition: fill 0.3s;
        }

        /* Trust score colors */
        .score-1 { stroke: #22c55e; fill: #22c55e; }
        .score-2 { stroke: #eab308; fill: #eab308; }
        .score-3 { stroke: #ef4444; fill: #ef4444; }
        .score-0 { stroke: #d1d5db; fill: #d1d5db; }

        .legend {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .legend-color {
            width: 20px;
            height: 3px;
        }

        .info-panel {
            margin-top: 20px;
            padding: 15px;
            background: #fef3c7;
            border-radius: 10px;
            border: 1px solid #fcd34d;
        }

        .info-panel h3 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .info-panel p {
            color: #78350f;
            line-height: 1.6;
        }

        .node-count {
            text-align: center;
            color: #666;
            margin-top: 10px;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding: 20px;
            color: white;
        }

        .footer p {
            margin: 5px 0;
            font-size: 14px;
        }

        .footer-subtitle {
            font-style: italic;
            opacity: 0.9;
            font-size: 13px !important;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            animation: slideIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-close {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            line-height: 1;
            transition: color 0.3s;
            background: transparent;
            border: none;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-close:focus {
            outline: 3px solid #00A8CC;
            outline-offset: 2px;
            color: #333;
        }

        .modal h2 {
            color: #2E4A8B;
            margin-bottom: 20px;
        }

        .modal h3 {
            color: #2E4A8B;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .help-button {
            position: absolute;
            right: 20px;
            top: 20px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #2E4A8B;
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        .help-button:hover {
            background: #1e3460;
            transform: scale(1.1);
        }

        .demo-button {
            background: #8BC34A;
            color: white;
        }

        .demo-button:hover {
            background: #7CB342;
        }

        .welcome-slides {
            position: relative;
        }

        .slide {
            display: none;
        }

        .slide.active {
            display: block;
        }

        .slide-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }

        .slide-dots {
            display: flex;
            gap: 8px;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #d0d0d0;
            transition: background 0.3s;
            border: none;
            cursor: pointer;
            padding: 0;
        }

        .dot.active {
            background: #2E4A8B;
        }

        .dot:hover {
            background: #666;
        }

        .dot:focus {
            outline: 2px solid #00A8CC;
            outline-offset: 3px;
        }

        .checkbox-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .feature-card {
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 3px solid #00A8CC;
        }

        .feature-card h4 {
            color: #2E4A8B;
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 1.5em;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group {
                flex-direction: column;
            }

            input[type="text"], button {
                width: 100%;
            }
        }

        .cloud-button {
            background: #00A8CC;
            color: white;
        }

        .cloud-button:hover {
            background: #0096b3;
        }

        .share-modal {
            display: none;
        }

        .share-link-container {
            padding: 20px;
        }

        .share-link {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 10px;
        }

        .share-link input {
            flex: 1;
            padding: 8px;
            border: 1px solid #90caf9;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }

        .copy-button {
            padding: 8px 15px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }

        .copy-button:hover {
            background: #1976D2;
        }

        /* Version History Styles */
        .version-list {
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }

        .version-item {
            padding: 15px;
            margin: 10px 0;
            background: #f5f5f5;
            border-radius: 8px;
            border-left: 4px solid #2E4A8B;
            transition: background 0.2s;
        }

        .version-item:hover {
            background: #e8f4f8;
        }

        .version-item.current {
            border-left-color: #00A8CC;
            background: #e8f4f8;
        }

        .version-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .version-number {
            font-weight: bold;
            color: #2E4A8B;
            font-size: 14px;
        }

        .version-timestamp {
            font-size: 12px;
            color: #666;
        }

        .version-summary {
            margin: 8px 0;
            color: #333;
            font-size: 13px;
        }

        .version-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .version-actions button {
            padding: 5px 12px;
            font-size: 12px;
        }

        .version-stats {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .version-stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 18px;
            font-weight: bold;
            color: #2E4A8B;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
            margin-top: 3px;
        }

        .comparison-view {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .comparison-header {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 20px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #2E4A8B;
        }

        .comparison-version {
            text-align: center;
        }

        .comparison-arrow {
            display: flex;
            align-items: center;
            color: #666;
            font-size: 20px;
        }

        .diff-section {
            margin: 15px 0;
        }

        .diff-section h4 {
            color: #2E4A8B;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .diff-item {
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            font-size: 13px;
        }

        .diff-added {
            background: #d4edda;
            border-left: 3px solid #28a745;
            color: #155724;
        }

        .diff-removed {
            background: #f8d7da;
            border-left: 3px solid #dc3545;
            color: #721c24;
        }

        .diff-modified {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            color: #856404;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .version-timeline {
            position: relative;
            padding-left: 30px;
        }

        .version-timeline::before {
            content: '';
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #ddd;
        }

        .version-timeline .version-item {
            position: relative;
        }

        .version-timeline .version-item::before {
            content: '';
            position: absolute;
            left: -24px;
            top: 15px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #2E4A8B;
            border: 2px solid white;
            box-shadow: 0 0 0 2px #2E4A8B;
        }

        .version-timeline .version-item.current::before {
            background: #00A8CC;
            box-shadow: 0 0 0 2px #00A8CC;
        }

        .btn-restore {
            background: #28a745;
        }

        .btn-restore:hover {
            background: #218838;
        }

        .btn-compare {
            background: #17a2b8;
        }

        .btn-compare:hover {
            background: #138496;
        }

        .btn-delete {
            background: #dc3545;
        }

        .btn-delete:hover {
            background: #c82333;
        }

        .manual-save-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #00A8CC;
            color: white;
            border-radius: 12px;
            font-size: 10px;
            margin-left: 8px;
        }
    </style>
    <!-- Toast Notifications -->
    <link rel="stylesheet" href="toast-notifications.css">
    <!-- Supabase and Cloud Storage -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="input-validation.js"></script>
    <script src="toast-notifications.js"></script>
    <script src="cloud-storage.js"></script>
    <script src="version-history.js"></script>
    <script src="accessibility-improvements.js"></script>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>

    <div class="container" role="main">
        <button class="help-button" onclick="showHelpModal()" aria-label="Open help and documentation" title="Help">?</button>

        <header class="header">
            <img src="background-assets/ProActive-ReSolutions-full-logo.png" alt="ProActive ReSolutions logo" class="logo">
            <h1>ProActive True Valence Mapper</h1>
            <p class="subtitle">Visualize trust flow in your relationships</p>
        </header>

        <nav id="controls" class="controls" aria-label="Map controls">
            <div class="control-group">
                <label for="personName" class="sr-only">Person's name</label>
                <input
                    type="text"
                    id="personName"
                    placeholder="Enter person's name"
                    maxlength="20"
                    aria-label="Enter person's name"
                    aria-describedby="nodeCount">
                <button
                    id="addPerson"
                    onclick="addPerson()"
                    aria-label="Add person to relationship map">
                    Add Person
                </button>
            </div>
            <div class="control-group" role="group" aria-label="Map management">
                <button
                    id="clearAll"
                    onclick="clearAll()"
                    aria-label="Clear all relationships from map">
                    Clear All
                </button>
                <button
                    id="saveMap"
                    onclick="saveMap()"
                    aria-label="Save map to browser storage">
                    Save Map
                </button>
                <button
                    id="loadMap"
                    onclick="loadMap()"
                    aria-label="Load map from browser storage">
                    Load Map
                </button>
                <button
                    onclick="showVersionHistory()"
                    aria-label="View version history">
                    <span aria-hidden="true">üìú</span> Version History
                </button>
            </div>
            <div class="control-group" role="group" aria-label="Import and export">
                <button
                    onclick="exportToJSON()"
                    aria-label="Export map as JSON file">
                    Export JSON
                </button>
                <button
                    onclick="importJSON()"
                    aria-label="Import map from JSON file">
                    Import JSON
                </button>
                <button
                    class="demo-button"
                    onclick="loadDemoData()"
                    aria-label="Load example data with sample relationships">
                    Load Example
                </button>
            </div>
            <div class="control-group" role="group" aria-label="Cloud storage">
                <button
                    class="cloud-button"
                    onclick="saveToCloud()"
                    aria-label="Save map to cloud storage">
                    <span aria-hidden="true">‚òÅÔ∏è</span> Save to Cloud
                </button>
                <button
                    class="cloud-button"
                    onclick="showMyMaps()"
                    aria-label="View my cloud saved maps">
                    <span aria-hidden="true">üìÅ</span> My Cloud Maps
                </button>
                <button
                    class="cloud-button"
                    onclick="shareMap()"
                    aria-label="Get shareable link for this map">
                    <span aria-hidden="true">üîó</span> Get Share Link
                </button>
            </div>
        </nav>

        <div class="node-count" id="nodeCount" aria-live="polite" aria-atomic="true">Relationships: 0 / 8</div>

        <main id="main-content">
            <section id="visualization" class="visualization-container" aria-label="Trust relationship visualization">
                <h2 class="sr-only">Trust Map Visualization</h2>
                <svg
                    id="trustMap"
                    viewBox="0 0 600 500"
                    role="img"
                    aria-label="Interactive trust map showing bidirectional trust relationships. Use Tab to navigate between connections, Enter or Space to change trust levels, and arrow keys to adjust scores."
                    focusable="false">
                <!-- Define arrow markers -->
                <defs>
                    <marker id="arrow-1" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
                        <path d="M0,0 L0,6 L9,3 z" class="arrow-marker score-1" />
                    </marker>
                    <marker id="arrow-2" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
                        <path d="M0,0 L0,6 L9,3 z" class="arrow-marker score-2" />
                    </marker>
                    <marker id="arrow-3" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
                        <path d="M0,0 L0,6 L9,3 z" class="arrow-marker score-3" />
                    </marker>
                    <marker id="arrow-0" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth">
                        <path d="M0,0 L0,6 L9,3 z" class="arrow-marker score-0" />
                    </marker>
                </defs>

                <!-- Nodes group (drawn first, behind arrows) -->
                <g id="nodes" role="group" aria-label="Relationship nodes">
                    <!-- Center node (You) -->
                    <circle cx="300" cy="250" r="40" class="node-circle center-node" role="img" aria-label="You - center of trust map" />
                    <text x="300" y="255" class="node-text center-text" aria-hidden="true">You</text>
                </g>

                <!-- Arrows group (drawn last, on top for clickability) -->
                <g id="arrows"></g>
            </svg>
            </section>
        </main>

        <aside class="legend" role="region" aria-label="Trust level color legend">
            <div class="legend-item">
                <div class="legend-color" style="background: #22c55e;" aria-hidden="true"></div>
                <span>High Trust (1)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #eab308;" aria-hidden="true"></div>
                <span>Medium Trust (2)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ef4444;" aria-hidden="true"></div>
                <span>Low/No Trust (3)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #d1d5db;" aria-hidden="true"></div>
                <span>Not Scored</span>
            </div>
        </aside>

        <section class="info-panel" role="region" aria-labelledby="how-to-use-heading">
            <h2 id="how-to-use-heading">How to Use</h2>
            <p>
                <strong>1. Add People:</strong> Enter names of up to 8 people in your relationship network.<br>
                <strong>2. Score Trust:</strong> Click the arrows to score trust levels (1-3):<br>
                <span role="list">
                    <span role="listitem">&nbsp;&nbsp;‚Ä¢ Outward arrow: "How confident am I that I'd go to them with a problem?"</span><br>
                    <span role="listitem">&nbsp;&nbsp;‚Ä¢ Inward arrow: "How confident am I that they'd come to me with a problem?"</span><br>
                </span>
                <strong>3. See Patterns:</strong> Green shows high trust, yellow shows medium, red shows low/no trust.<br>
                <strong>4. Save Your Map:</strong> Use Save/Load to keep your progress.
            </p>
        </section>
    </div>

    <script>
        // State management
        let relationships = [];
        let trustScores = {};
        const MAX_NODES = 8;
        const CENTER_X = 300;
        const CENTER_Y = 250;
        const RADIUS = 150;

        // Cloud Storage variables
        let cloudStorage;
        let currentMapId = null;

        // Version History variables
        let versionHistory;

        // Toast Manager
        let toastMgr;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize toast manager
            toastMgr = initToastManager({ duration: 3000 });
            // Initialize version history
            versionHistory = new VersionHistory();
            // Initialize cloud storage
            cloudStorage = new CloudStorage();

            // Update connection status
            updateConnectionStatus();
            setInterval(updateConnectionStatus, 30000);

            // Check for share code in URL
            const shareCode = cloudStorage.checkForShareCode();
            if (shareCode) {
                loadSharedMap(shareCode);
            } else {
                // Check if first visit
                if (!localStorage.getItem('hideWelcome')) {
                    showWelcomeModal();
                }

                // Try to load saved map
                loadFromLocalStorage();
                updateNodeCount();
            }

            // Add enter key support
            document.getElementById('personName').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addPerson();
                }
            });

            // Add keyboard shortcut for help
            document.addEventListener('keypress', function(e) {
                if (e.key === '?') {
                    showHelpModal();
                }
            });

            // Add escape key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeAllModals();
                }
            });
        });

        function addPerson() {
            const input = document.getElementById('personName');
            const nameRaw = input.value.trim();

            // Validate input
            const validation = InputValidator.validatePersonName(nameRaw);
            if (!validation.isValid) {
                showError(validation.error);
                return;
            }

            const name = validation.sanitized;

            if (relationships.length >= MAX_NODES) {
                showError(`Maximum ${MAX_NODES} relationships allowed`);
                return;
            }

            // Check for duplicates (case-insensitive)
            if (relationships.find(r => r.name.toLowerCase() === name.toLowerCase())) {
                showError('This person already exists');
                return;
            }

            // Add the person with validated name
            const person = {
                id: Date.now(),
                name: name
            };
            relationships.push(person);

            // Initialize trust scores
            trustScores[person.id] = {
                outward: 0, // You -> Them
                inward: 0   // Them -> You
            };

            // Clear input
            input.value = '';

            // Update visualization
            renderVisualization();
            updateNodeCount();
            saveToLocalStorage();

            // Auto-save version
            if (versionHistory && versionHistory.shouldAutoSave()) {
                autoSaveVersion();
            }

            // Announce to screen readers
            if (window.a11yManager) {
                window.a11yManager.announce(`${name} added to relationship map`, 'assertive');
            }
        }

        function renderVisualization() {
            const arrowsGroup = document.getElementById('arrows');
            const nodesGroup = document.getElementById('nodes');

            // Clear existing nodes (except center)
            const existingNodes = nodesGroup.querySelectorAll('.relationship-node');
            existingNodes.forEach(node => node.remove());

            // Clear existing arrows
            arrowsGroup.innerHTML = '';

            // Calculate positions for each node
            relationships.forEach((person, index) => {
                const angle = (index * 2 * Math.PI) / relationships.length - Math.PI / 2;
                const x = CENTER_X + RADIUS * Math.cos(angle);
                const y = CENTER_Y + RADIUS * Math.sin(angle);

                // Create arrows (two per relationship)
                createArrows(person, x, y);

                // Create node
                createNode(person, x, y);
            });
        }

        function createArrows(person, x, y) {
            const arrowsGroup = document.getElementById('arrows');

            // Calculate direction vector
            const dx = x - CENTER_X;
            const dy = y - CENTER_Y;
            const length = Math.sqrt(dx * dx + dy * dy);

            // Normalize the direction vector
            const normalX = dx / length;
            const normalY = dy / length;

            // Calculate perpendicular vector for parallel offset
            const perpX = -normalY * 8;  // 8 pixels offset perpendicular to the line
            const perpY = normalX * 8;   // This creates parallel arrows

            // Start and end points for arrows (adjusted to not overlap at nodes)
            const startRadius = 45;  // Start 45px from center (just outside center node)
            const endRadius = 35;    // End 35px from target (just outside target node)

            // Base positions along the main axis
            const baseStartX = CENTER_X + normalX * startRadius;
            const baseStartY = CENTER_Y + normalY * startRadius;
            const baseEndX = CENTER_X + normalX * (length - endRadius);
            const baseEndY = CENTER_Y + normalY * (length - endRadius);

            // Trust level names for accessibility
            const scoreNames = ['not scored', 'high trust', 'medium trust', 'low trust'];

            // Outward arrow (You -> Them) - offset to one side
            const outwardScore = trustScores[person.id].outward;
            const outwardPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const outwardStartX = baseStartX - perpX;
            const outwardStartY = baseStartY - perpY;
            const outwardEndX = baseEndX - perpX;
            const outwardEndY = baseEndY - perpY;
            const outwardD = `M ${outwardStartX} ${outwardStartY} L ${outwardEndX} ${outwardEndY}`;
            outwardPath.setAttribute('d', outwardD);
            outwardPath.setAttribute('class', `arrow-path score-${outwardScore}`);
            outwardPath.setAttribute('marker-end', `url(#arrow-${outwardScore})`);
            outwardPath.setAttribute('data-person', person.id);
            outwardPath.setAttribute('data-direction', 'outward');
            outwardPath.setAttribute('tabindex', '0');
            outwardPath.setAttribute('role', 'button');
            outwardPath.setAttribute('aria-label', `Your trust in ${person.name}: ${scoreNames[outwardScore]}. Press Enter or Space to change, use arrow keys to adjust.`);
            outwardPath.onclick = () => cycleScore(person.id, 'outward');

            // Inward arrow (Them -> You) - offset to the other side
            const inwardScore = trustScores[person.id].inward;
            const inwardPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            const inwardStartX = baseStartX + perpX;
            const inwardStartY = baseStartY + perpY;
            const inwardEndX = baseEndX + perpX;
            const inwardEndY = baseEndY + perpY;
            const inwardD = `M ${inwardEndX} ${inwardEndY} L ${inwardStartX} ${inwardStartY}`;
            inwardPath.setAttribute('d', inwardD);
            inwardPath.setAttribute('class', `arrow-path score-${inwardScore}`);
            inwardPath.setAttribute('marker-end', `url(#arrow-${inwardScore})`);
            inwardPath.setAttribute('data-person', person.id);
            inwardPath.setAttribute('data-direction', 'inward');
            inwardPath.setAttribute('tabindex', '0');
            inwardPath.setAttribute('role', 'button');
            inwardPath.setAttribute('aria-label', `${person.name}'s trust in you: ${scoreNames[inwardScore]}. Press Enter or Space to change, use arrow keys to adjust.`);
            inwardPath.onclick = () => cycleScore(person.id, 'inward');

            arrowsGroup.appendChild(outwardPath);
            arrowsGroup.appendChild(inwardPath);
        }

        function createNode(person, x, y) {
            const nodesGroup = document.getElementById('nodes');

            const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            g.setAttribute('class', 'relationship-node');

            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', y);
            circle.setAttribute('r', 30);
            circle.setAttribute('class', 'node-circle');

            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', x);
            text.setAttribute('y', y + 5);
            text.setAttribute('class', 'node-text');

            // Sanitize person name for safe SVG display
            const safeName = InputValidator.sanitizeForSVGDisplay(person.name, 30);
            text.textContent = safeName;

            g.appendChild(circle);
            g.appendChild(text);
            nodesGroup.appendChild(g);
        }

        function cycleScore(personId, direction) {
            // Cycle through scores: 0 -> 1 -> 2 -> 3 -> 0
            const currentScore = trustScores[personId][direction];
            const newScore = (currentScore + 1) % 4;
            trustScores[personId][direction] = newScore;

            // Announce change to screen readers
            if (window.a11yManager) {
                const person = relationships.find(r => r.id == personId);
                const scoreNames = ['not scored', 'high trust', 'medium trust', 'low trust'];
                const directionName = direction === 'outward' ? 'your trust in them' : 'their trust in you';
                window.a11yManager.announce(`${person ? person.name + ', ' : ''}${directionName} changed to ${scoreNames[newScore]}`, 'polite');
            }

            // Re-render to update colors
            renderVisualization();
            saveToLocalStorage();
        }

        function updateNodeCount() {
            const nodeCountEl = document.getElementById('nodeCount');
            nodeCountEl.textContent = `Relationships: ${relationships.length} / ${MAX_NODES}`;

            const addButton = document.getElementById('addPerson');
            const isDisabled = relationships.length >= MAX_NODES;
            addButton.disabled = isDisabled;

            if (isDisabled) {
                addButton.setAttribute('aria-disabled', 'true');
            } else {
                addButton.removeAttribute('aria-disabled');
            }
        }

        function clearAll() {
            if (confirm('Are you sure you want to clear all relationships?')) {
                // Save version before clearing
                if (versionHistory && relationships.length > 0) {
                    autoSaveVersion();
                }

                relationships = [];
                trustScores = {};
                renderVisualization();
                updateNodeCount();
                saveToLocalStorage();

                // Announce to screen readers
                if (window.a11yManager) {
                    window.a11yManager.announce('All relationships cleared from map', 'assertive');
                }
            }
        }

        function saveMap() {
            saveToLocalStorage();
            showSuccess('Map saved to browser storage');

            // Announce to screen readers
            if (window.a11yManager) {
                window.a11yManager.announce('Map saved to browser storage', 'assertive');
            }
        }

        function loadMap() {
            const success = loadFromLocalStorage();
            if (success) {
                showSuccess('Map loaded successfully');

                // Announce to screen readers
                if (window.a11yManager) {
                    window.a11yManager.announce('Map loaded successfully', 'assertive');
                }
            } else {
                showWarning('No saved map found');
            }
        }

        function saveToLocalStorage() {
            const data = {
                relationships: relationships,
                trustScores: trustScores,
                timestamp: new Date().toISOString()
            };
            localStorage.setItem('trustValenceMap', JSON.stringify(data));
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('trustValenceMap');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    relationships = data.relationships || [];
                    trustScores = data.trustScores || {};
                    renderVisualization();
                    updateNodeCount();
                    return true;
                } catch (e) {
                    console.error('Error loading saved map:', e);
                    return false;
                }
            }
            return false;
        }

        // Export/Import Functions
        function exportToJSON() {
            const data = {
                version: "1.0",
                appName: "ProActive True Valence Mapper",
                relationships: relationships,
                trustScores: trustScores,
                exportDate: new Date().toISOString()
            };

            const dataStr = JSON.stringify(data, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});

            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `trust-map-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function importJSON() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';

            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);

                        // Validate and sanitize the imported data
                        const sanitized = InputValidator.sanitizeImportedJSON(data);
                        const validation = InputValidator.validateMapData(sanitized);

                        if (validation.isValid && validation.data && validation.data.relationships.length > 0) {
                            // Confirm before overwriting
                            if (relationships.length > 0) {
                                if (!confirm('This will replace your current map. Continue?')) {
                                    return;
                                }
                                // Save current state before importing
                                if (versionHistory) {
                                    autoSaveVersion();
                                }
                            }

                            relationships = validation.data.relationships;
                            trustScores = validation.data.trustScores;

                            renderVisualization();
                            updateNodeCount();
                            saveToLocalStorage();

                            // Create version for imported map
                            if (versionHistory) {
                                versionHistory.createVersion(
                                    { relationships, trustScores },
                                    'Imported from JSON file',
                                    true
                                );
                            }

                            showSuccess('Map imported successfully!');
                        } else {
                            const errorMsg = validation.errors.length > 0
                                ? `Validation errors: ${validation.errors.join(', ')}`
                                : 'Invalid file format. Please select a valid trust map JSON file.';
                            showError(errorMsg);
                        }
                    } catch (error) {
                        console.error('Import error:', error);
                        showError('Error reading file. Please ensure it\'s a valid JSON file.');
                    }
                };
                reader.readAsText(file);
            };

            input.click();
        }

        // Modal Functions
        let currentSlideIndex = 1;

        function showWelcomeModal() {
            document.getElementById('welcomeModal').classList.add('show');
            currentSlideIndex = 1;
            showSlide(currentSlideIndex);
        }

        function closeWelcomeModal() {
            document.getElementById('welcomeModal').classList.remove('show');
        }

        function showHelpModal() {
            document.getElementById('helpModal').classList.add('show');
        }

        function closeHelpModal() {
            document.getElementById('helpModal').classList.remove('show');
        }

        function closeAllModals() {
            closeWelcomeModal();
            closeHelpModal();
        }

        function changeSlide(n) {
            showSlide(currentSlideIndex += n);
        }

        function currentSlide(n) {
            showSlide(currentSlideIndex = n);
        }

        function showSlide(n) {
            const slides = document.getElementsByClassName('slide');
            const dots = document.getElementsByClassName('dot');

            if (n > slides.length) currentSlideIndex = 1;
            if (n < 1) currentSlideIndex = slides.length;

            for (let i = 0; i < slides.length; i++) {
                slides[i].classList.remove('active');
            }

            for (let i = 0; i < dots.length; i++) {
                dots[i].classList.remove('active');
                dots[i].setAttribute('aria-selected', 'false');
            }

            slides[currentSlideIndex - 1].classList.add('active');
            dots[currentSlideIndex - 1].classList.add('active');
            dots[currentSlideIndex - 1].setAttribute('aria-selected', 'true');

            // Update navigation buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            prevBtn.style.visibility = currentSlideIndex === 1 ? 'hidden' : 'visible';
            prevBtn.setAttribute('aria-hidden', currentSlideIndex === 1 ? 'true' : 'false');

            const isLastSlide = currentSlideIndex === slides.length;
            nextBtn.textContent = isLastSlide ? 'Get Started' : 'Next';
            nextBtn.setAttribute('aria-label', isLastSlide ? 'Get started with the application' : 'Next slide');

            if (isLastSlide) {
                nextBtn.onclick = function() {
                    closeWelcomeModal();
                };
            } else {
                nextBtn.onclick = function() {
                    changeSlide(1);
                };
            }

            // Announce slide change to screen readers
            if (window.a11yManager) {
                window.a11yManager.announce(`Slide ${currentSlideIndex} of ${slides.length}`, 'polite');
            }
        }

        function updateWelcomePreference() {
            const checkbox = document.getElementById('dontShowAgain');
            if (checkbox.checked) {
                localStorage.setItem('hideWelcome', 'true');
            } else {
                localStorage.removeItem('hideWelcome');
            }
        }

        // Demo Mode Function
        function loadDemoData() {
            // Confirm before loading demo (keep confirm for this important action)
            if (relationships.length > 0) {
                if (!confirm('This will replace your current map with sample data. Continue?')) {
                    return;
                }
            }

            // Clear existing
            relationships = [];
            trustScores = {};

            // Add demo relationships
            const demoNames = ['Sarah (Partner)', 'Mom', 'Best Friend Alex', 'Boss Jennifer', 'Brother Mike', 'Therapist Dr. Lee'];

            demoNames.forEach(name => {
                const person = {
                    id: Date.now() + Math.random(),
                    name: name
                };
                relationships.push(person);

                // Set demo trust scores
                trustScores[person.id] = {
                    outward: 0,
                    inward: 0
                };
            });

            // Set specific demo scores to show patterns
            if (relationships[0]) trustScores[relationships[0].id] = { outward: 1, inward: 1 }; // Partner - high both ways
            if (relationships[1]) trustScores[relationships[1].id] = { outward: 1, inward: 2 }; // Mom - asymmetric
            if (relationships[2]) trustScores[relationships[2].id] = { outward: 1, inward: 1 }; // Best Friend - high both
            if (relationships[3]) trustScores[relationships[3].id] = { outward: 2, inward: 3 }; // Boss - professional distance
            if (relationships[4]) trustScores[relationships[4].id] = { outward: 2, inward: 2 }; // Brother - medium both
            if (relationships[5]) trustScores[relationships[5].id] = { outward: 1, inward: 3 }; // Therapist - one-way professional

            renderVisualization();
            updateNodeCount();
            saveToLocalStorage();

            // Create version for demo data
            if (versionHistory) {
                versionHistory.createVersion(
                    { relationships, trustScores },
                    'Loaded demo data with sample relationships',
                    true
                );
            }

            // Show a tip
            showInfo('Demo loaded! Click any arrow to see how trust scoring works. Notice the asymmetric patterns in some relationships.');
        }

        // Cloud Storage Functions
        function updateConnectionStatus() {
            const statusEl = document.getElementById('cloudStatus');
            const statusText = document.getElementById('statusText');

            if (navigator.onLine) {
                statusEl.className = 'cloud-status online';
                statusText.textContent = '‚òÅÔ∏è Cloud sync enabled';
            } else {
                statusEl.className = 'cloud-status offline';
                statusText.textContent = 'üíæ Offline mode';
            }
        }

        async function saveToCloud() {
            if (relationships.length === 0) {
                showError('Add some relationships before saving to cloud');
                return;
            }

            let mapName = prompt('Name your map:', 'Trust Map ' + new Date().toLocaleDateString());
            if (!mapName) return;

            // Validate and sanitize map name
            const nameValidation = InputValidator.validateMapName(mapName);
            if (!nameValidation.isValid) {
                showError(nameValidation.error);
                return;
            }
            mapName = nameValidation.sanitized;

            const mapData = {
                relationships: relationships,
                trustScores: trustScores
            };

            const result = await cloudStorage.saveToCloud(mapData, mapName);

            if (result.success) {
                currentMapId = result.id;
                if (result.shareCode) {
                    showShareLink(result.shareCode, result.shareUrl);
                }
            }
        }

        async function loadSharedMap(shareCode) {
            const result = await cloudStorage.loadFromCloud(shareCode);

            if (result.success) {
                relationships = result.data.relationships || [];
                trustScores = result.data.trustScores || {};
                renderVisualization();
                updateNodeCount();

                cloudStorage.showStatus(`Loaded shared map: ${result.data.mapName}`, 'success');
            }
        }

        async function showMyMaps() {
            const modal = document.getElementById('myMapsModal');
            const mapsList = document.getElementById('mapsList');

            modal.classList.add('show');
            mapsList.innerHTML = '<p>Loading...</p>';

            const result = await cloudStorage.getMyMaps();

            if (result.success) {
                if (result.maps.length === 0) {
                    mapsList.innerHTML = '<p style="text-align: center; color: #666;">No saved maps yet.<br><br>Save your first map to the cloud!</p>';
                } else {
                    mapsList.innerHTML = result.maps.map(map => {
                        // Sanitize map name for safe HTML display
                        const safeName = InputValidator.htmlEncode(map.map_name);
                        const safeShareCode = InputValidator.htmlEncode(map.share_code || '');
                        const mapId = InputValidator.htmlEncode(map.id);

                        return `
                            <div style="padding: 15px; margin: 10px 0; background: #f5f5f5; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <h4 style="margin: 0 0 5px 0; color: #2E4A8B;">${safeName}</h4>
                                    <span style="font-size: 12px; color: #666;">Updated: ${new Date(map.updated_at).toLocaleString()}</span>
                                    ${safeShareCode ? `<br><small style="font-family: monospace;">Share: ${safeShareCode}</small>` : ''}
                                </div>
                                <div style="display: flex; gap: 8px;">
                                    <button style="padding: 5px 10px; font-size: 12px;" onclick="loadMapFromCloud('${mapId}')">Load</button>
                                    ${safeShareCode ? `<button style="padding: 5px 10px; font-size: 12px;" onclick="getShareLink('${safeShareCode}')">Share</button>` : ''}
                                    <button style="padding: 5px 10px; font-size: 12px; background: #f44336;" onclick="deleteCloudMap('${mapId}')">Delete</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            } else {
                mapsList.innerHTML = '<p style="text-align: center; color: #f44336;">Failed to load maps. Check your connection.</p>';
            }
        }

        function closeMyMapsModal() {
            document.getElementById('myMapsModal').classList.remove('show');
        }

        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('show');
        }

        async function loadMapFromCloud(mapId) {
            const result = await cloudStorage.loadFromCloud(mapId);

            if (result.success) {
                relationships = result.data.relationships || [];
                trustScores = result.data.trustScores || {};
                currentMapId = mapId;

                renderVisualization();
                updateNodeCount();
                closeMyMapsModal();

                cloudStorage.showStatus('Map loaded successfully', 'success');
            }
        }

        async function deleteCloudMap(mapId) {
            if (!confirm('Delete this map? This cannot be undone.')) return;

            const result = await cloudStorage.deleteMap(mapId);
            if (result.success) {
                showMyMaps(); // Refresh the list
            }
        }

        function shareMap() {
            if (!currentMapId) {
                showError('Please save your map to the cloud first');
                return;
            }

            const refs = JSON.parse(localStorage.getItem('mapReferences') || '{}');
            const ref = refs[currentMapId];

            if (ref && ref.shareCode) {
                const shareUrl = cloudStorage.getShareUrl(ref.shareCode);
                showShareLink(ref.shareCode, shareUrl);
            }
        }

        function showShareLink(shareCode, shareUrl) {
            const modal = document.getElementById('shareModal');
            const urlInput = document.getElementById('shareUrl');
            const codeEl = document.getElementById('shareCode');

            urlInput.value = shareUrl;
            codeEl.textContent = shareCode;
            modal.classList.add('show');
        }

        function copyShareLink() {
            const urlInput = document.getElementById('shareUrl');
            urlInput.select();
            document.execCommand('copy');

            showSuccess('Link copied to clipboard!');
            setTimeout(() => closeShareModal(), 1500);
        }

        function getShareLink(shareCode) {
            if (shareCode && shareCode !== 'null') {
                const shareUrl = cloudStorage.getShareUrl(shareCode);
                showShareLink(shareCode, shareUrl);
                closeMyMapsModal();
            }
        }

        // Add close modal on escape for new modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMyMapsModal();
                closeShareModal();
                closeVersionHistoryModal();
                closeVersionCompareModal();
            }
        });

        // ============================================
        // VERSION HISTORY FUNCTIONS
        // ============================================

        /**
         * Show version history modal
         */
        function showVersionHistory() {
            const modal = document.getElementById('versionHistoryModal');
            modal.classList.add('show');

            renderVersionHistory();
        }

        /**
         * Close version history modal
         */
        function closeVersionHistoryModal() {
            document.getElementById('versionHistoryModal').classList.remove('show');
        }

        /**
         * Close version comparison modal
         */
        function closeVersionCompareModal() {
            document.getElementById('versionCompareModal').classList.remove('show');
        }

        /**
         * Render version history list and statistics
         */
        function renderVersionHistory() {
            const stats = versionHistory.getStatistics();
            const versions = versionHistory.getAllVersions();

            // Render statistics
            const statsEl = document.getElementById('versionStats');
            statsEl.innerHTML = `
                <h3 style="margin-bottom: 10px;">Statistics</h3>
                <div class="version-stats-grid">
                    <div class="stat-item">
                        <div class="stat-value">${stats.totalVersions}</div>
                        <div class="stat-label">Total Versions</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.manualSaves}</div>
                        <div class="stat-label">Manual Saves</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${stats.autoSaves}</div>
                        <div class="stat-label">Auto Saves</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">${versionHistory.getStorageSize()} KB</div>
                        <div class="stat-label">Storage Used</div>
                    </div>
                </div>
            `;

            // Render version list
            const listEl = document.getElementById('versionList');

            if (versions.length === 0) {
                listEl.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon" aria-hidden="true">üìú</div>
                        <p>No version history yet</p>
                        <p style="font-size: 12px; margin-top: 10px;">Versions are created automatically when you make changes</p>
                    </div>
                `;
                return;
            }

            // Get current version (latest)
            const latestVersion = versions[versions.length - 1];

            listEl.innerHTML = versions.reverse().map(version => {
                const isCurrent = version.versionNumber === latestVersion.versionNumber;
                const timestamp = VersionHistory.formatTimestamp(version.timestamp);

                return `
                    <div class="version-item ${isCurrent ? 'current' : ''}" data-version="${version.versionNumber}">
                        <div class="version-header">
                            <div>
                                <span class="version-number">v${version.versionNumber}</span>
                                ${version.isManual ? '<span class="manual-save-badge">Manual Save</span>' : ''}
                                ${isCurrent ? '<span class="manual-save-badge" style="background: #00A8CC;">Current</span>' : ''}
                            </div>
                            <div class="version-timestamp">${timestamp}</div>
                        </div>
                        <div class="version-summary">${InputValidator.htmlEncode(version.changeSummary)}</div>
                        <div style="font-size: 11px; color: #666; margin-top: 5px;">
                            ${version.metadata.relationshipCount} relationship(s)
                        </div>
                        <div class="version-actions">
                            ${!isCurrent ? `<button class="btn-restore" onclick="restoreVersion(${version.versionNumber})" aria-label="Restore version ${version.versionNumber}">Restore</button>` : ''}
                            <button class="btn-compare" onclick="showVersionComparison(${version.versionNumber})" aria-label="Compare version ${version.versionNumber}">Compare</button>
                            ${!isCurrent ? `<button class="btn-delete" onclick="deleteVersion(${version.versionNumber})" aria-label="Delete version ${version.versionNumber}">Delete</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        /**
         * Create a manual version save
         */
        function createManualVersion() {
            const summary = prompt('Enter a description for this version (optional):');
            if (summary === null) return; // User cancelled

            const mapData = {
                relationships: relationships,
                trustScores: trustScores
            };

            versionHistory.createVersion(mapData, summary || '', true);
            renderVersionHistory();

            if (window.a11yManager) {
                window.a11yManager.announce('Version saved successfully', 'assertive');
            }
        }

        /**
         * Auto-save version on significant changes
         */
        function autoSaveVersion() {
            if (relationships.length === 0) return; // Don't save empty maps

            const mapData = {
                relationships: relationships,
                trustScores: trustScores
            };

            versionHistory.createVersion(mapData, '', false);
        }

        /**
         * Restore a specific version
         */
        function restoreVersion(versionNumber) {
            if (!confirm(`Restore to version ${versionNumber}? Current changes will be saved as a new version.`)) {
                return;
            }

            // Save current state before restoring
            autoSaveVersion();

            // Restore the version
            const restored = versionHistory.restoreVersion(versionNumber);
            if (restored) {
                relationships = restored.relationships;
                trustScores = restored.trustScores;

                renderVisualization();
                updateNodeCount();
                saveToLocalStorage();

                closeVersionHistoryModal();

                if (window.a11yManager) {
                    window.a11yManager.announce(`Version ${versionNumber} restored`, 'assertive');
                }

                alert(`Version ${versionNumber} restored successfully!`);
            } else {
                alert('Failed to restore version');
            }
        }

        /**
         * Delete a specific version
         */
        function deleteVersion(versionNumber) {
            if (!confirm(`Delete version ${versionNumber}? This cannot be undone.`)) {
                return;
            }

            if (versionHistory.deleteVersion(versionNumber)) {
                renderVersionHistory();

                if (window.a11yManager) {
                    window.a11yManager.announce(`Version ${versionNumber} deleted`, 'assertive');
                }
            } else {
                alert('Failed to delete version');
            }
        }

        /**
         * Show version comparison modal
         */
        function showVersionComparison(defaultVersion) {
            const modal = document.getElementById('versionCompareModal');
            const versions = versionHistory.getAllVersions();

            if (versions.length < 2) {
                alert('Need at least 2 versions to compare');
                return;
            }

            // Populate dropdowns
            const v1Select = document.getElementById('compareV1');
            const v2Select = document.getElementById('compareV2');

            v1Select.innerHTML = versions.map(v =>
                `<option value="${v.versionNumber}" ${v.versionNumber === defaultVersion ? 'selected' : ''}>
                    v${v.versionNumber} - ${VersionHistory.formatTimestamp(v.timestamp)}
                </option>`
            ).join('');

            v2Select.innerHTML = versions.map(v =>
                `<option value="${v.versionNumber}" ${v.versionNumber === versions[versions.length - 1].versionNumber && defaultVersion !== v.versionNumber ? 'selected' : ''}>
                    v${v.versionNumber} - ${VersionHistory.formatTimestamp(v.timestamp)}
                </option>`
            ).join('');

            modal.classList.add('show');

            // Auto-perform comparison
            performComparison();
        }

        /**
         * Perform version comparison
         */
        function performComparison() {
            const v1 = parseInt(document.getElementById('compareV1').value);
            const v2 = parseInt(document.getElementById('compareV2').value);

            if (v1 === v2) {
                document.getElementById('comparisonResult').innerHTML = '<p style="text-align: center; color: #666;">Please select two different versions to compare.</p>';
                return;
            }

            const comparison = versionHistory.compareVersions(v1, v2);

            if (comparison.error) {
                document.getElementById('comparisonResult').innerHTML = `<p style="text-align: center; color: #f44336;">${comparison.error}</p>`;
                return;
            }

            let html = `
                <div class="comparison-view">
                    <div class="comparison-header">
                        <div class="comparison-version">
                            <h3>Version ${comparison.version1.number}</h3>
                            <p style="font-size: 12px; color: #666;">${VersionHistory.formatTimestamp(comparison.version1.timestamp)}</p>
                            <p style="font-size: 12px; margin-top: 5px;">${comparison.version1.relationshipCount} relationships</p>
                        </div>
                        <div class="comparison-arrow">‚Üí</div>
                        <div class="comparison-version">
                            <h3>Version ${comparison.version2.number}</h3>
                            <p style="font-size: 12px; color: #666;">${VersionHistory.formatTimestamp(comparison.version2.timestamp)}</p>
                            <p style="font-size: 12px; margin-top: 5px;">${comparison.version2.relationshipCount} relationships</p>
                        </div>
                    </div>
            `;

            const diff = comparison.differences;

            // Added relationships
            if (diff.added.length > 0) {
                html += `
                    <div class="diff-section">
                        <h4>Added Relationships (${diff.added.length})</h4>
                        ${diff.added.map(name => `<div class="diff-item diff-added">+ ${InputValidator.htmlEncode(name)}</div>`).join('')}
                    </div>
                `;
            }

            // Removed relationships
            if (diff.removed.length > 0) {
                html += `
                    <div class="diff-section">
                        <h4>Removed Relationships (${diff.removed.length})</h4>
                        ${diff.removed.map(name => `<div class="diff-item diff-removed">- ${InputValidator.htmlEncode(name)}</div>`).join('')}
                    </div>
                `;
            }

            // Modified trust scores
            if (diff.modified.length > 0) {
                html += `
                    <div class="diff-section">
                        <h4>Modified Trust Scores (${diff.modified.length})</h4>
                        ${diff.modified.map(m => {
                            const v1Out = m.v1.outward;
                            const v1In = m.v1.inward;
                            const v2Out = m.v2.outward;
                            const v2In = m.v2.inward;

                            return `
                                <div class="diff-item diff-modified">
                                    <strong>${InputValidator.htmlEncode(m.name)}</strong><br>
                                    <span style="font-size: 11px;">
                                        Outward: ${v1Out} ‚Üí ${v2Out} | Inward: ${v1In} ‚Üí ${v2In}
                                    </span>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
            }

            if (diff.added.length === 0 && diff.removed.length === 0 && diff.modified.length === 0) {
                html += '<p style="text-align: center; color: #666; padding: 20px;">No differences found between these versions.</p>';
            }

            html += '</div>';

            document.getElementById('comparisonResult').innerHTML = html;
        }

        /**
         * Export version history
         */
        function exportVersionHistory() {
            const json = versionHistory.exportVersionHistory();
            const blob = new Blob([json], { type: 'application/json' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `version-history-${new Date().toISOString().split('T')[0]}.json`;
            link.click();

            if (window.a11yManager) {
                window.a11yManager.announce('Version history exported', 'assertive');
            }
        }

        /**
         * Clear all version history
         */
        function clearVersionHistory() {
            if (!confirm('Clear all version history? This cannot be undone.')) {
                return;
            }

            versionHistory.clearAllVersions();
            renderVersionHistory();

            if (window.a11yManager) {
                window.a11yManager.announce('Version history cleared', 'assertive');
            }
        }
    </script>

    <!-- Welcome Modal -->
    <div id="welcomeModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="welcome-modal-title">
        <div class="modal-content">
            <button class="modal-close" onclick="closeWelcomeModal()" aria-label="Close welcome dialog">&times;</button>
            <div class="welcome-slides">
                <!-- Slide 1: What -->
                <div class="slide active">
                    <h2 id="welcome-modal-title">Welcome to ProActive True Valence Mapper</h2>
                    <p>A powerful visualization tool for understanding trust dynamics in your relationships.</p>
                    <br>
                    <h3>What is a Trust Valence Map?</h3>
                    <p>It's a visual representation showing bidirectional trust flow between you and the people in your life. Each relationship has two arrows:</p>
                    <ul style="margin: 15px 0; padding-left: 20px;">
                        <li><strong>Outward Arrow (Solid):</strong> Your confidence in going to them with problems</li>
                        <li><strong>Inward Arrow (Dashed):</strong> Your perception of their willingness to come to you</li>
                    </ul>
                </div>

                <!-- Slide 2: Why -->
                <div class="slide">
                    <h2>Why Map Trust Flow?</h2>
                    <div class="feature-grid">
                        <div class="feature-card">
                            <h4>Identify Patterns</h4>
                            <p>See imbalances in your relationships at a glance</p>
                        </div>
                        <div class="feature-card">
                            <h4>Track Progress</h4>
                            <p>Monitor how trust evolves over time</p>
                        </div>
                        <div class="feature-card">
                            <h4>Facilitate Conversations</h4>
                            <p>Use visual aids to discuss trust with coaches or therapists</p>
                        </div>
                        <div class="feature-card">
                            <h4>Build Awareness</h4>
                            <p>Understand where to invest emotional energy</p>
                        </div>
                    </div>
                </div>

                <!-- Slide 3: How -->
                <div class="slide">
                    <h2>How to Use This Tool</h2>
                    <ol style="line-height: 1.8; padding-left: 20px;">
                        <li><strong>Add People:</strong> Enter up to 8 names from your relationship network</li>
                        <li><strong>Score Trust:</strong> Click arrows to cycle through trust levels:
                            <ul style="margin: 10px 0;">
                                <li>üü¢ Green = High Trust (Score 1)</li>
                                <li>üü° Yellow = Medium Trust (Score 2)</li>
                                <li>üî¥ Red = Low/No Trust (Score 3)</li>
                                <li>‚ö™ Gray = Not Yet Scored</li>
                            </ul>
                        </li>
                        <li><strong>Save Your Work:</strong> Use Export JSON to backup or Import to restore</li>
                        <li><strong>Try Demo:</strong> Click "Load Example" to see a sample map</li>
                    </ol>
                </div>
            </div>

            <nav class="slide-nav" aria-label="Welcome slides navigation">
                <button id="prevBtn" onclick="changeSlide(-1)" style="visibility: hidden;" aria-label="Previous slide">Previous</button>
                <div class="slide-dots" role="tablist" aria-label="Slide indicators">
                    <button class="dot active" onclick="currentSlide(1)" role="tab" aria-label="Slide 1 of 3" aria-selected="true"></button>
                    <button class="dot" onclick="currentSlide(2)" role="tab" aria-label="Slide 2 of 3" aria-selected="false"></button>
                    <button class="dot" onclick="currentSlide(3)" role="tab" aria-label="Slide 3 of 3" aria-selected="false"></button>
                </div>
                <button id="nextBtn" onclick="changeSlide(1)" aria-label="Next slide">Next</button>
            </nav>

            <div class="checkbox-container">
                <input type="checkbox" id="dontShowAgain" onchange="updateWelcomePreference()" aria-describedby="dont-show-label">
                <label for="dontShowAgain" id="dont-show-label">Don't show this again</label>
            </div>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="help-modal-title">
        <div class="modal-content">
            <button class="modal-close" onclick="closeHelpModal()" aria-label="Close help dialog">&times;</button>
            <h2 id="help-modal-title">Help & Documentation</h2>

            <h3>Quick Start Guide</h3>
            <ol style="line-height: 1.8; padding-left: 20px;">
                <li>Add people by typing their name and clicking "Add Person"</li>
                <li>Click the arrows connecting "You" to each person</li>
                <li>Each click cycles the trust score (Gray ‚Üí Green ‚Üí Yellow ‚Üí Red ‚Üí Gray)</li>
                <li>Save your map locally or export as JSON for backup</li>
            </ol>

            <h3>For Coaches & Facilitators</h3>
            <p><strong>Suggested Questions to Ask Clients:</strong></p>
            <ul style="margin: 15px 0; padding-left: 20px;">
                <li>"Who would you turn to first if you had a problem?"</li>
                <li>"Who do you think would come to you with their challenges?"</li>
                <li>"Where do you see asymmetry in these relationships?"</li>
                <li>"What would need to change to strengthen these connections?"</li>
            </ul>

            <h3>Privacy & Data Security</h3>
            <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin: 15px 0;">
                <p><strong>üîí Your data is private and secure:</strong></p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    <li>All data stored locally in your browser</li>
                    <li>No account or login required</li>
                    <li>Export creates offline backup files</li>
                    <li>You control who sees your maps</li>
                </ul>
            </div>

            <h3>Keyboard Shortcuts</h3>
            <ul style="padding-left: 20px;">
                <li><kbd>Enter</kbd> - Add person (when typing name)</li>
                <li><kbd>?</kbd> - Open this help menu</li>
                <li><kbd>Esc</kbd> - Close modals</li>
            </ul>

            <h3>Features</h3>
            <div class="feature-grid">
                <div class="feature-card">
                    <h4>Save/Load</h4>
                    <p>Stores in browser memory</p>
                </div>
                <div class="feature-card">
                    <h4>Export/Import</h4>
                    <p>JSON backup files</p>
                </div>
                <div class="feature-card">
                    <h4>Demo Mode</h4>
                    <p>Try with sample data</p>
                </div>
                <div class="feature-card">
                    <h4>8 Relationships</h4>
                    <p>Optimal for clarity</p>
                </div>
            </div>

            <h3>About ProActive ReSolutions</h3>
            <p>ProActive ReSolutions Inc. specializes in relationship coaching and team dynamics visualization tools. This mapper helps individuals and organizations understand trust patterns for improved communication and collaboration.</p>
        </div>
    </div>


    <!-- Share Modal -->
    <div id="shareModal" class="modal share-modal" role="dialog" aria-modal="true" aria-labelledby="share-modal-title">
        <div class="modal-content">
            <button class="modal-close" onclick="closeShareModal()" aria-label="Close share dialog">&times;</button>
            <div class="share-link-container">
                <h2 id="share-modal-title">Share Your Trust Map</h2>
                <p>Anyone with this link can view your map:</p>
                <div class="share-link">
                    <label for="shareUrl" class="sr-only">Share link URL</label>
                    <input type="text" id="shareUrl" readonly aria-label="Shareable link URL">
                    <button class="copy-button" onclick="copyShareLink()" aria-label="Copy share link to clipboard">Copy Link</button>
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    Share code: <code id="shareCode"></code>
                </p>
            </div>
        </div>
    </div>

    <!-- My Maps Modal -->
    <div id="myMapsModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="my-maps-modal-title">
        <div class="modal-content">
            <button class="modal-close" onclick="closeMyMapsModal()" aria-label="Close my maps dialog">&times;</button>
            <h2 id="my-maps-modal-title">My Cloud Maps</h2>
            <div id="mapsList" class="map-list" style="max-height: 400px; overflow-y: auto;" role="region" aria-live="polite" aria-busy="false">
                <p>Loading maps...</p>
            </div>
        </div>
    </div>

    <!-- Version History Modal -->
    <div id="versionHistoryModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="version-history-title">
        <div class="modal-content">
            <button class="modal-close" onclick="closeVersionHistoryModal()" aria-label="Close version history dialog">&times;</button>
            <h2 id="version-history-title">Version History</h2>

            <!-- Statistics -->
            <div id="versionStats" class="version-stats"></div>

            <!-- Actions -->
            <div style="display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;">
                <button onclick="createManualVersion()" aria-label="Save current state as new version">
                    <span aria-hidden="true">üíæ</span> Save Version
                </button>
                <button onclick="exportVersionHistory()" aria-label="Export version history">
                    <span aria-hidden="true">üì§</span> Export History
                </button>
                <button class="btn-delete" onclick="clearVersionHistory()" aria-label="Clear all version history">
                    <span aria-hidden="true">üóëÔ∏è</span> Clear All
                </button>
            </div>

            <!-- Version List -->
            <div id="versionList" class="version-list version-timeline" role="region" aria-live="polite">
                <div class="empty-state">
                    <div class="empty-state-icon" aria-hidden="true">üìú</div>
                    <p>No version history yet</p>
                    <p style="font-size: 12px; margin-top: 10px;">Versions are created automatically when you make changes</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Version Comparison Modal -->
    <div id="versionCompareModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="version-compare-title">
        <div class="modal-content">
            <button class="modal-close" onclick="closeVersionCompareModal()" aria-label="Close version comparison dialog">&times;</button>
            <h2 id="version-compare-title">Compare Versions</h2>

            <div style="margin-bottom: 20px;">
                <label for="compareV1">Version 1:</label>
                <select id="compareV1" style="margin: 0 10px; padding: 5px;"></select>

                <label for="compareV2">Version 2:</label>
                <select id="compareV2" style="margin: 0 10px; padding: 5px;"></select>

                <button onclick="performComparison()">Compare</button>
            </div>

            <div id="comparisonResult"></div>
        </div>
    </div>

    <footer class="footer" role="contentinfo">
        <p>&copy; 2024 ProActive ReSolutions Inc. All rights reserved. | <a href="privacy-policy.html" style="color: #00A8CC; text-decoration: underline;">Privacy Policy</a></p>
        <p class="footer-subtitle">Empowering relationships through trust visualization</p>
    </footer>
</body>
</html>